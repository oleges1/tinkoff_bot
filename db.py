from datetime import datetime, timedelta
from pony.orm import *
from utils import generate_bot_data



db = Database()


class User(db.Entity):
    id = PrimaryKey(int, auto=True)
    telegram_id = Optional(int, nullable=True)
    first_name = Optional(str, nullable=True)
    last_name = Optional(str, nullable=True)
    username = Optional(str, nullable=True)
    state = Optional(str, nullable=True)
    coins = Optional(int, nullable=True)
    energy = Optional(int, nullable=True)
    exp = Optional(int, nullable=True)
    team = Optional('Team', nullable=True)

    @staticmethod
    def random_user():
        return User(
            **generate_bot_data()
        )

    @staticmethod
    def user_from_update(update):
        from_user = update.message.from_user
        return User(
            telegram_id=from_user.id,
            first_name=from_user.first_name,
            last_name=from_user.last_name,
            username=from_user.username,
            coins=100,
            state='start',
            energy=10
        )


class Team(db.Entity):
    id = PrimaryKey(int, auto=True)
    name = Optional(str)
    users = Set(User)
    league = Optional(str)

    # TODO: admins = Set(User)


# class Location(db.Entity):
#     id = PrimaryKey(int, auto=True)
#     name = Optional(str)
#     meetings = Set('Meeting')
#     workspace = Required(Workspace)
#
#
# class Meeting(db.Entity):
#     id = PrimaryKey(int, auto=True)
#     name = Optional(str)
#     users = Set(User)
#     location = Required(Location)
#     start_time = Optional(datetime)
#     end_time = Optional(datetime)


db.bind(provider='sqlite', filename='sql', create_db=True)
db.generate_mapping(create_tables=True)


states = {
    'start': {
        'buttons' : [
            ['üåê–§–æ—Ä—É–ºüåê', 'üìà–ë–∏—Ä–∂–∞üìà', 'üßê–ö–≤–∏–∑—ãüßê'],
            ['–ü—Ä–æ—Ñ–∏–ª—å','üèÜ–†–µ–π—Ç–∏–Ω–≥ –∫–æ–º–∞–Ω–¥üèÜ'],
        ],
        'text' : """–¢—ã –º–æ–∂–µ—à—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è –Ω–∞:

üåê–§–æ—Ä—É–ºüåê - –∑–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ —Å—Ä–∞–∂–µ–Ω–∏—è–º–∏

üìà–ë–∏—Ä–∂—Éüìà - –∏—Å–ø—ã—Ç–∞—Ç—å —É–¥–∞—á—É

üßê–ö–≤–∏–∑—ãüßê - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ—é —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å –∏ –ø–æ–æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã :)

–ò–ª–∏ –∑–∞–≥–ª—è–Ω—É—Ç—å –≤ –ø—Ä–æ—Ñ–∏–ª—å""",
    },


    'stock' : {
        'buttons' : [
            ['–ì–æ—Ç–æ–≤!'],
            ['–ù–∞–∑–∞–¥üîô']
        ],
        'text' : '–¢—ã –ø—Ä–∏—à–µ–ª –Ω–∞ –±–∏—Ä–∂—É. –ó–∞—Ö–æ–¥—è –≤ –∏–≥—Ä—É, —Ç—ã —É–≤–∏–¥–∏—à—å –∫—É—Ä—Å –∞–∫—Ü–∏–π –∫–∞–∫–æ–π-—Ç–æ –∫–æ–º–ø–∞–Ω–∏–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—É—Ç–∫–∏. –ß—Ç–æ–±—ã –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –∫–æ–º–ø–∞–Ω–∏–∏, –Ω–∞–∑–æ–≤–µ–º –µ–µ "–û—Ä–≥–µ–ª–æ". –¢–≤–æ–µ–π —Ü–µ–ª—å—é –±—É–¥–µ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å, –ø–æ–≤—ã—Å–∏—Ç—Å—è –∏–ª–∏ –ø–æ–Ω–∏–∑–∏—Ç—å—Å—è –∫—É—Ä—Å –≤ —Ç–µ—á–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–∏—Ö 12 —á–∞—Å–æ–≤. –ì–æ—Ç–æ–≤ —Å—ã–≥—Ä–∞—Ç—å?'
    },

    # 'oleg' : {
    #     'buttons' : [
    #         ['–û–ª–µ–≥'],
    #         ['–ù–∞–∑–∞–¥üîô', '–ú–µ–Ω—éüìã']
    #     ],
    #     'text' : '–û–ª–µ–≥'
    # },

    'bet' : {
        'buttons' : [
            ['–í–≤–µ—Ä—Ö‚òùÔ∏è', '–í–Ω–∏–∑üëá'],
            ['–ù–∞–∑–∞–¥üîô', '–ú–µ–Ω—éüìã']
        ],
        'text' : '–°–ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–π, –≤ –∫–∞–∫—É—é —Å—Ç–æ—Ä–æ–Ω—É –ø–æ–π–¥–µ—Ç –≥—Ä–∞—Ñ–∏–∫ –∫—É—Ä—Å–∞ '
    },

    'bet up' : {
        'buttons' : [['–ù–∞–∑–∞–¥üîô']],
        'text' : '–¢—ã —Ä–µ—à–∏–ª –∏–≥—Ä–∞—Ç—å –Ω–∞ –ø–æ–≤—ã—à–µ–Ω–∏–µ. –°–∫–æ–ª—å–∫–æ –æ–ª–µ–≥—Ä–æ —Ç—ã –≥–æ—Ç–æ–≤ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —Ç–æ, —á—Ç–æ –∫—É—Ä—Å –ø–æ–≤—ã—Å–∏—Ç—Å—è?'
    },

    'bet down' : {
        'buttons' : [['–ù–∞–∑–∞–¥üîô']],
        'text' : '–¢—ã —Ä–µ—à–∏–ª –∏–≥—Ä–∞—Ç—å –Ω–∞ –ø–æ–Ω–∏–∂–µ–Ω–∏–µ. –°–∫–æ–ª—å–∫–æ –æ–ª–µ–≥—Ä–æ —Ç—ã –≥–æ—Ç–æ–≤ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —Ç–æ, —á—Ç–æ –∫—É—Ä—Å –ø–æ–Ω–∏–∑–∏—Ç—Å—è?'
    },

    'results_win' : {
        'buttons' : [['–ù–∞–∑–∞–¥üîô', '–ú–µ–Ω—éüìã']],
        'text' : '–¢—ã –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤! –ú–æ–∂–µ—à—å –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ —Ç–æ, –∫–∞–∫–∏–º –¥–∞–ª—å—à–µ –±—ã–ª –≥—Ä–∞—Ñ–∏–∫ –∏ –æ—Ç–ø—Ä–∞–∑–¥–Ω–æ–≤–∞—Ç—å –ø–æ–±–µ–¥—É!'
    },

    'results_lose' : {
        'buttons' : [['–ù–∞–∑–∞–¥üîô', '–ú–µ–Ω—éüìã']],
        'text' : '–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Ç–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑ –æ–∫–∞–∑–∞–ª—Å—è –Ω–µ–≤–µ—Ä–µ–Ω. –ú–æ–∂–µ—à—å –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ —Ç–æ, –∫–∞–∫–∏–º –¥–∞–ª—å—à–µ –±—ã–ª –≥—Ä–∞—Ñ–∏–∫.'
    },

    'results_draw' : {
        'buttons' : [['–ù–∞–∑–∞–¥üîô', '–ú–µ–Ω—éüìã']],
        'text' : '–≠—Ç–æ –∫–∞–∫–∞—è-—Ç–æ –º–∏—Å—Ç–∏–∫–∞, –Ω–æ —á–µ—Ä–µ–∑ 12 —á–∞—Å–æ–≤ –∑–Ω–∞—á–µ–Ω–∏—è –∫—É—Ä—Å–∞ —Ä–æ–≤–Ω–æ —Ç–∞–∫–∏–µ –∂–µ, –∫–∞–∫ –∏ –≤ –∫–æ–Ω—Ü–µ –ø–µ—Ä–∏–æ–¥–∞, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –Ω–∞–±–ª—é–¥–∞–ª! –ú—ã –≤–µ—Ä–Ω–µ–º —Ç–µ–±–µ –¥–µ–Ω—å–≥–∏ –∑–∞ —Å—Ç–∞–≤–∫—É.'
    },

    'profile': {
        'buttons' : [['–°—Ç–∞—Ç—É—Å', '–ú–æ—è –∫–æ–º–∞–Ω–¥–∞', '–ü–æ–∏—Å–∫ –∫–æ–º–∞–Ω–¥—ã'], ['–ù–∞–∑–∞–¥üîô', '–ú–µ–Ω—éüìã']],
        'text': '–≠—Ç–æ –ø—Ä–æ—Ñ–∏–ª—å —Ç–≤–æ–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.'
    },

    'teaming': {
        'buttons': [['–ù–∞–∑–∞–¥üîô', '–ú–µ–Ω—éüìã']],
        'text': '–ù–∞–ø–∏—à–∏ —Å—é–¥–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã –∏ —è –ª–∏–±–æ —Å–æ–∑–¥–∞–º —Ç–∞–∫—É—é –∫–æ–º–∞–Ω–¥—É, –ª–∏–±–æ –æ—Ç—ã—â—É –µ—ë'
    },
    'game': {
        'buttons': [['–ì–æ—Ç–æ–≤ üí™'], ['–ù–∞–∑–∞–¥üîô', '–ú–µ–Ω—éüìã']],
        'text': '–ü—Ä–∏–≤–µ—Ç. –Ø –ø—Ä–∏–≥–æ—Ç–æ–≤–∏–ª –¥–ª—è —Ç–µ–±—è –ø–∞—Ä–æ—á–∫—É –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤. –ó–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã —Ç—ã –±—É–¥–µ—à—å –ø–æ–ª—É—á–∞—Ç—å –Ω–µ–º–Ω–æ–≥–æ –æ–ª–µ–≥–ø—Ä–æ üí∞ –∏ –æ–ø—ã—Ç–∞. –ì–æ—Ç–æ–≤?'
    },
    'game2': {},
    'game3': {
        'buttons': [['–ù–∞–∑–∞–¥üîô', '–ú–µ–Ω—éüìã'], ['–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º!']],
        'text': '–ù—É —á—Ç–æ –µ—â–µ —Ä–∞–∑–æ–∫?'
    },
}
